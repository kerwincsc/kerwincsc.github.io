firewalld 说明
==============

与Linux系统中其他的防火墙策略配置工具一样,
使用 firewalld 配置的防火墙策略默认为运行时 (Runtime) 模式,
又称为 **当前生效模式**, 而且随着系统的重启会失效.
如果想让配置策略一直存在, 就需要使用 **永久 (Permanent) 模式** 了,
方法就是在用 firewall-cmd 命令正常设置防火墙策略时 **添加 --permanent 参数**,
这样配置的防火墙策略就可以永久生效了. 但是, 永久生效模式有一个 " 不近人情 " 的特点,
就是使用它设置的 **策略只有在系统重启之后才能自动生效**.
如果想让配置的策略 **立即生效, 需要手动执行 firewall-cmd --reload** 命令;

- firewalld 中常用的区域名称及策略规则

  +---------------+--------------------------------------------------------------------+
  | 区域          | 默认策略规则                                                       |
  +===============+====================================================================+
  | trusted       | 允许所有的数据包                                                   |
  +---------------+--------------------------------------------------------------------+
  | home          | 拒绝流入的流量, 除非与流出的流量相关; 而如果流量与 ssh, mdns,      |
  |               | ipp-client, amba-client 和 dhcpv6-client 服务相关, 则允许流量      |
  +---------------+--------------------------------------------------------------------+
  | internal      | 等同于 home 区域                                                   |
  +---------------+--------------------------------------------------------------------+
  | work          | 拒绝流入的流量, 除非与流出的流量数相关;                            |
  |               | 而如果流量与 ssh, ipp-client 和 dhcpv6-client 服务相关, 则允许流量 |
  +---------------+--------------------------------------------------------------------+
  | public        | 拒绝流入的流量, 除非与流出的流量相关;                              |
  |               | 而如果流量与 ssh, ipp-client 与 dhcpv6-client 服务相关, 则允许流量 |
  +---------------+--------------------------------------------------------------------+
  | external      | 拒绝流入的流量, 除非与流出的流量相关;                              |
  |               | 而如果流量与 ssh 服务相关, 则允许流量                              |
  +---------------+--------------------------------------------------------------------+
  | dmz           | 拒绝流入的流量, 除非与流出的流量相关;                              |
  |               | 而如果流量与 ssh 服务相关, 则允许流量                              |
  +---------------+--------------------------------------------------------------------+
  | block         | 拒绝流入的流量, 除非与流出的流量相关;                              |
  +---------------+--------------------------------------------------------------------+
  | drop          | 拒绝流入的流量, 除非与流出的流量相关;                              |
  +---------------+--------------------------------------------------------------------+


- firewall-cmd 命令中使用的参数及作用

  +---------------------------------+-------------------------------------------+
  | 参数                            | 作用                                      |
  +=================================+===========================================+
  | --get-default-zone              | 查询默认的区域名称                        |
  +---------------------------------+-------------------------------------------+
  | --set-default-zone=< 区域名称 > | 设置默认的区域, 使其永久生效              |
  +---------------------------------+-------------------------------------------+
  | --get-zones                     | 显示可用的区域                            |
  +---------------------------------+-------------------------------------------+
  | --get-services                  | 显示预定义的服务                          |
  +---------------------------------+-------------------------------------------+
  | --get-active-zones              | 显示当前正在使用的区域与网卡名称          |
  +---------------------------------+-------------------------------------------+
  | --add-source=                   | 将源自此 IP 或子网的流量导向某个指定区域  |
  +---------------------------------+-------------------------------------------+
  | --remove-source=                | 不再将源自此 ip 或子网的流量导向某个指定区域 |
  +---------------------------------+-------------------------------------------+
  | --add-interface=< 网卡名称 >    | 将源自该网卡的所有流量都导向某个指定区域  |
  +---------------------------------+-------------------------------------------+
  | --change-interface=< 网卡名称 > | 将某个网卡与区域进行关联                  |
  +---------------------------------+-------------------------------------------+
  | --list-all                      | 显示当前区域的网卡配置参数, 资源, 端口    |
  |                                 | 以及服务等信息                            |
  +---------------------------------+-------------------------------------------+
  | --list-all-zones                | 显示所有区域的网卡配置参数, 资源, 端口    |
  |                                 | 及服务等信息                              |
  +---------------------------------+-------------------------------------------+
  | --add-services=< 服务名 >       | 设置默认区域允许该服务的流量              |
  +---------------------------------+-------------------------------------------+
  | --add-port=< 端口号 / 协议 >    | 设置默认区域允许该端口的流量              |
  +---------------------------------+-------------------------------------------+
  | --remove-services=< 服务名 >    | 设置默认区域不再允许该服务的流量          |
  +---------------------------------+-------------------------------------------+
  | --remove-port=< 端口号 / 协议 > | 设置默认区域不再允许该端口的流量          |
  +---------------------------------+-------------------------------------------+
  | --reload                        | 让 " 永久生效 " 的配置规则立即生效,       |
  |                                 | 并覆盖当前的配置规则                      |
  +---------------------------------+-------------------------------------------+
  | --panic-on                      | 开启应急状况模式                          |
  +---------------------------------+-------------------------------------------+
  | --panic-off                     | 关闭应急状况模式                          |
  +---------------------------------+-------------------------------------------+


常用案例
========

- 查看 firewalld 服务当前所使用的区域

  .. code-block:: shell

     firewall-cmd --get-default-zone

- 查询 eno16777728 网卡在 firewalld 服务中的区域

  .. code-block:: shell

     firewall-cmd --get-zone-of-interface=eno16777728

- 把 firewalld 服务的当前默认区域设置为 public

  .. code-block:: shell

     firewall-cmd --set-default-zone=public

- 启动 / 关闭 firewalld 防火墙服务的应急状况模式,
  阻断一切网络连接 ( 当远程控制服务器时请慎用 )

  .. code-block:: shell


     firewall-cmd --panic-on
     firewall-cmd --panic-off

- 查询 public 区域是否允许请求 SSH 和 HTTPS 协议的流量

  .. code-block:: shell

     firewall-cmd --zone=public --query-service=ssh
     firewall-cmd --zone=public --query-service=https

- 把 firewalld 服务中请求 HTTPS 协议的流量设置为永久允许, 并立即生效

  .. code-block:: shell
     :linenos:

     firewall-cmd --zone=public --add-service=https
     firewall-cmd --permanent --zone=public --add-service=https
     firewall-cmd --reload

- 把 firewalld 服务中请求 HTTP 协议的流量设置为永久拒绝, 并立即生效

  .. code-block:: shell
     :linenos:

     firewall-cmd --permanent --zone=pulibc --remove-service=http
     firewall-cmd --reload

- 把在 firewalld 服务中访问 8080 和 8081 端口的流量策略设置为允许, 但仅限当前生效

  .. code-block:: shell

     firewall-cmd --zone=public --add-port=8080-8081/tcp

     $ firewall-cmd --zone=public --list-ports
     8080-8081/tcp

- 把原本访问本机 888 端口的流量转发到 22 端口, 要且求当前和长期均有效

  流量转发命令格式为:

  firewall-cmd --permanent --zone=<区域>
  \--add-forward-port=port=<源端口号>:proto=<协议>:toport=<目标端口号>:toaddr=<目标IP地址>

  .. code-block:: shell
     :linenos:

     firewall-cmd --permanent --zone=public --add-forward-port=
     port=888:proto=tcp:toport=22:toaddr=192.168.10.10

     firewall-cmd --reload

- 在 firewalld 服务中配置一条 *富规则*,
  使其拒绝 192.168.10.0/24 网段的所有用户访问本机的 ssh 服务 ( 22 端口 )

  .. code-block:: shell

     firewall-cmd --permanent --zone=public --add-rich-rule="
     rule family="ipv4" source address="192.168.10.0/24" service name="ssh" reject"

     firewall-cmd --reload
